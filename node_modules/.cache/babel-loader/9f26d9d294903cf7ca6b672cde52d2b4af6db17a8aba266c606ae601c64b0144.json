{"ast":null,"code":"import { VERSION } from '../../sdk-info.js';\nimport { CB_KEYS_URL } from '../constants.js';\nimport { standardErrors } from '../error/errors.js';\nimport { closePopup, openPopup } from '../../util/web.js';\n/**\n * Communicates with a popup window for Coinbase keys.coinbase.com (or another url)\n * to send and receive messages.\n *\n * This class is responsible for opening a popup window, posting messages to it,\n * and listening for responses.\n *\n * It also handles cleanup of event listeners and the popup window itself when necessary.\n */\nexport class Communicator {\n  constructor(_ref) {\n    let {\n      url = CB_KEYS_URL,\n      metadata,\n      preference\n    } = _ref;\n    this.popup = null;\n    this.listeners = new Map();\n    /**\n     * Posts a message to the popup window\n     */\n    this.postMessage = async message => {\n      const popup = await this.waitForPopupLoaded();\n      popup.postMessage(message, this.url.origin);\n    };\n    /**\n     * Posts a request to the popup window and waits for a response\n     */\n    this.postRequestAndWaitForResponse = async request => {\n      const responsePromise = this.onMessage(_ref2 => {\n        let {\n          requestId\n        } = _ref2;\n        return requestId === request.id;\n      });\n      this.postMessage(request);\n      return await responsePromise;\n    };\n    /**\n     * Listens for messages from the popup window that match a given predicate.\n     */\n    this.onMessage = async predicate => {\n      return new Promise((resolve, reject) => {\n        const listener = event => {\n          if (event.origin !== this.url.origin) return; // origin validation\n          const message = event.data;\n          if (predicate(message)) {\n            resolve(message);\n            window.removeEventListener('message', listener);\n            this.listeners.delete(listener);\n          }\n        };\n        window.addEventListener('message', listener);\n        this.listeners.set(listener, {\n          reject\n        });\n      });\n    };\n    /**\n     * Closes the popup, rejects all requests and clears the listeners\n     */\n    this.disconnect = () => {\n      // Note: keys popup handles closing itself. this is a fallback.\n      closePopup(this.popup);\n      this.popup = null;\n      this.listeners.forEach((_ref3, listener) => {\n        let {\n          reject\n        } = _ref3;\n        reject(standardErrors.provider.userRejectedRequest('Request rejected'));\n        window.removeEventListener('message', listener);\n      });\n      this.listeners.clear();\n    };\n    /**\n     * Waits for the popup window to fully load and then sends a version message.\n     */\n    this.waitForPopupLoaded = async () => {\n      if (this.popup && !this.popup.closed) {\n        // In case the user un-focused the popup between requests, focus it again\n        this.popup.focus();\n        return this.popup;\n      }\n      this.popup = await openPopup(this.url);\n      this.onMessage(_ref4 => {\n        let {\n          event\n        } = _ref4;\n        return event === 'PopupUnload';\n      }).then(this.disconnect).catch(() => {});\n      return this.onMessage(_ref5 => {\n        let {\n          event\n        } = _ref5;\n        return event === 'PopupLoaded';\n      }).then(message => {\n        this.postMessage({\n          requestId: message.id,\n          data: {\n            version: VERSION,\n            metadata: this.metadata,\n            preference: this.preference,\n            location: window.location.toString()\n          }\n        });\n      }).then(() => {\n        if (!this.popup) throw standardErrors.rpc.internal();\n        return this.popup;\n      });\n    };\n    this.url = new URL(url);\n    this.metadata = metadata;\n    this.preference = preference;\n  }\n}","map":{"version":3,"names":["VERSION","CB_KEYS_URL","standardErrors","closePopup","openPopup","Communicator","constructor","_ref","url","metadata","preference","popup","listeners","Map","postMessage","message","waitForPopupLoaded","origin","postRequestAndWaitForResponse","request","responsePromise","onMessage","_ref2","requestId","id","predicate","Promise","resolve","reject","listener","event","data","window","removeEventListener","delete","addEventListener","set","disconnect","forEach","_ref3","provider","userRejectedRequest","clear","closed","focus","_ref4","then","catch","_ref5","version","location","toString","rpc","internal","URL"],"sources":["../../../src/core/communicator/Communicator.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}