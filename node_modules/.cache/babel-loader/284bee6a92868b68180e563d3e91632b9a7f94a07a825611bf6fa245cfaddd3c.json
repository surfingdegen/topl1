{"ast":null,"code":"import { getTransactionCount } from '../actions/public/getTransactionCount.js';\nimport { LruMap } from './lru.js';\n/**\n * Creates a nonce manager for auto-incrementing transaction nonces.\n *\n * - Docs: https://viem.sh/docs/accounts/createNonceManager\n *\n * @example\n * ```ts\n * const nonceManager = createNonceManager({\n *   source: jsonRpc(),\n * })\n * ```\n */\nexport function createNonceManager(parameters) {\n  const {\n    source\n  } = parameters;\n  const deltaMap = new Map();\n  const nonceMap = new LruMap(8192);\n  const promiseMap = new Map();\n  const getKey = _ref => {\n    let {\n      address,\n      chainId\n    } = _ref;\n    return \"\".concat(address, \".\").concat(chainId);\n  };\n  return {\n    async consume(_ref2) {\n      let {\n        address,\n        chainId,\n        client\n      } = _ref2;\n      const key = getKey({\n        address,\n        chainId\n      });\n      const promise = this.get({\n        address,\n        chainId,\n        client\n      });\n      this.increment({\n        address,\n        chainId\n      });\n      const nonce = await promise;\n      await source.set({\n        address,\n        chainId\n      }, nonce);\n      nonceMap.set(key, nonce);\n      return nonce;\n    },\n    async increment(_ref3) {\n      var _deltaMap$get;\n      let {\n        address,\n        chainId\n      } = _ref3;\n      const key = getKey({\n        address,\n        chainId\n      });\n      const delta = (_deltaMap$get = deltaMap.get(key)) !== null && _deltaMap$get !== void 0 ? _deltaMap$get : 0;\n      deltaMap.set(key, delta + 1);\n    },\n    async get(_ref4) {\n      var _deltaMap$get2;\n      let {\n        address,\n        chainId,\n        client\n      } = _ref4;\n      const key = getKey({\n        address,\n        chainId\n      });\n      let promise = promiseMap.get(key);\n      if (!promise) {\n        promise = (async () => {\n          try {\n            var _nonceMap$get;\n            const nonce = await source.get({\n              address,\n              chainId,\n              client\n            });\n            const previousNonce = (_nonceMap$get = nonceMap.get(key)) !== null && _nonceMap$get !== void 0 ? _nonceMap$get : 0;\n            if (previousNonce > 0 && nonce <= previousNonce) return previousNonce + 1;\n            nonceMap.delete(key);\n            return nonce;\n          } finally {\n            this.reset({\n              address,\n              chainId\n            });\n          }\n        })();\n        promiseMap.set(key, promise);\n      }\n      const delta = (_deltaMap$get2 = deltaMap.get(key)) !== null && _deltaMap$get2 !== void 0 ? _deltaMap$get2 : 0;\n      return delta + (await promise);\n    },\n    reset(_ref5) {\n      let {\n        address,\n        chainId\n      } = _ref5;\n      const key = getKey({\n        address,\n        chainId\n      });\n      deltaMap.delete(key);\n      promiseMap.delete(key);\n    }\n  };\n}\n/** JSON-RPC source for a nonce manager. */\nexport function jsonRpc() {\n  return {\n    async get(parameters) {\n      const {\n        address,\n        client\n      } = parameters;\n      return getTransactionCount(client, {\n        address,\n        blockTag: 'pending'\n      });\n    },\n    set() {}\n  };\n}\n////////////////////////////////////////////////////////////////////////////////////////////\n// Default\n/** Default Nonce Manager with a JSON-RPC source. */\nexport const nonceManager = /*#__PURE__*/createNonceManager({\n  source: jsonRpc()\n});","map":{"version":3,"names":["getTransactionCount","LruMap","createNonceManager","parameters","source","deltaMap","Map","nonceMap","promiseMap","getKey","_ref","address","chainId","concat","consume","_ref2","client","key","promise","get","increment","nonce","set","_ref3","_deltaMap$get","delta","_ref4","_deltaMap$get2","_nonceMap$get","previousNonce","delete","reset","_ref5","jsonRpc","blockTag","nonceManager"],"sources":["/Users/mac/Desktop/topl1/frontend/node_modules/viem/utils/nonceManager.ts"],"sourcesContent":["import type { Address } from 'abitype'\n\nimport { getTransactionCount } from '../actions/public/getTransactionCount.js'\nimport type { Client } from '../clients/createClient.js'\nimport type { MaybePromise } from '../types/utils.js'\nimport { LruMap } from './lru.js'\n\nexport type CreateNonceManagerParameters = {\n  source: NonceManagerSource\n}\n\ntype FunctionParameters = {\n  address: Address\n  chainId: number\n}\n\nexport type NonceManager = {\n  /** Get and increment a nonce. */\n  consume: (\n    parameters: FunctionParameters & { client: Client },\n  ) => Promise<number>\n  /** Increment a nonce. */\n  increment: (chainId: FunctionParameters) => void\n  /** Get a nonce. */\n  get: (chainId: FunctionParameters & { client: Client }) => Promise<number>\n  /** Reset a nonce. */\n  reset: (chainId: FunctionParameters) => void\n}\n\n/**\n * Creates a nonce manager for auto-incrementing transaction nonces.\n *\n * - Docs: https://viem.sh/docs/accounts/createNonceManager\n *\n * @example\n * ```ts\n * const nonceManager = createNonceManager({\n *   source: jsonRpc(),\n * })\n * ```\n */\nexport function createNonceManager(\n  parameters: CreateNonceManagerParameters,\n): NonceManager {\n  const { source } = parameters\n\n  const deltaMap = new Map()\n  const nonceMap = new LruMap<number>(8192)\n  const promiseMap = new Map<string, Promise<number>>()\n\n  const getKey = ({ address, chainId }: FunctionParameters) =>\n    `${address}.${chainId}`\n\n  return {\n    async consume({ address, chainId, client }) {\n      const key = getKey({ address, chainId })\n      const promise = this.get({ address, chainId, client })\n\n      this.increment({ address, chainId })\n      const nonce = await promise\n\n      await source.set({ address, chainId }, nonce)\n      nonceMap.set(key, nonce)\n\n      return nonce\n    },\n    async increment({ address, chainId }) {\n      const key = getKey({ address, chainId })\n      const delta = deltaMap.get(key) ?? 0\n      deltaMap.set(key, delta + 1)\n    },\n    async get({ address, chainId, client }) {\n      const key = getKey({ address, chainId })\n\n      let promise = promiseMap.get(key)\n      if (!promise) {\n        promise = (async () => {\n          try {\n            const nonce = await source.get({ address, chainId, client })\n            const previousNonce = nonceMap.get(key) ?? 0\n            if (previousNonce > 0 && nonce <= previousNonce)\n              return previousNonce + 1\n            nonceMap.delete(key)\n            return nonce\n          } finally {\n            this.reset({ address, chainId })\n          }\n        })()\n        promiseMap.set(key, promise)\n      }\n\n      const delta = deltaMap.get(key) ?? 0\n      return delta + (await promise)\n    },\n    reset({ address, chainId }) {\n      const key = getKey({ address, chainId })\n      deltaMap.delete(key)\n      promiseMap.delete(key)\n    },\n  }\n}\n\n////////////////////////////////////////////////////////////////////////////////////////////\n// Sources\n\nexport type NonceManagerSource = {\n  /** Get a nonce. */\n  get(parameters: FunctionParameters & { client: Client }): MaybePromise<number>\n  /** Set a nonce. */\n  set(parameters: FunctionParameters, nonce: number): MaybePromise<void>\n}\n\n/** JSON-RPC source for a nonce manager. */\nexport function jsonRpc(): NonceManagerSource {\n  return {\n    async get(parameters) {\n      const { address, client } = parameters\n      return getTransactionCount(client, {\n        address,\n        blockTag: 'pending',\n      })\n    },\n    set() {},\n  }\n}\n\n////////////////////////////////////////////////////////////////////////////////////////////\n// Default\n\n/** Default Nonce Manager with a JSON-RPC source. */\nexport const nonceManager = /*#__PURE__*/ createNonceManager({\n  source: jsonRpc(),\n})\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}