{"ast":null,"code":"import { hexToNumber, isAddressEqual } from 'viem';\nimport { SCWKeyManager } from './SCWKeyManager.js';\nimport { assertGetCapabilitiesParams } from './utils.js';\nimport { standardErrors } from '../../core/error/errors.js';\nimport { ScopedLocalStorage } from '../../core/storage/ScopedLocalStorage.js';\nimport { ensureIntNumber, hexStringFromNumber } from '../../core/type/util.js';\nimport { decryptContent, encryptContent, exportKeyToHexString, importKeyFromHexString } from '../../util/cipher.js';\nimport { fetchRPCRequest } from '../../util/provider.js';\nconst ACCOUNTS_KEY = 'accounts';\nconst ACTIVE_CHAIN_STORAGE_KEY = 'activeChain';\nconst AVAILABLE_CHAINS_STORAGE_KEY = 'availableChains';\nconst WALLET_CAPABILITIES_STORAGE_KEY = 'walletCapabilities';\nexport class SCWSigner {\n  constructor(params) {\n    var _a, _b, _c;\n    this.metadata = params.metadata;\n    this.communicator = params.communicator;\n    this.callback = params.callback;\n    this.keyManager = new SCWKeyManager();\n    this.storage = new ScopedLocalStorage('CBWSDK', 'SCWStateManager');\n    this.accounts = (_a = this.storage.loadObject(ACCOUNTS_KEY)) !== null && _a !== void 0 ? _a : [];\n    this.chain = this.storage.loadObject(ACTIVE_CHAIN_STORAGE_KEY) || {\n      id: (_c = (_b = params.metadata.appChainIds) === null || _b === void 0 ? void 0 : _b[0]) !== null && _c !== void 0 ? _c : 1\n    };\n    this.handshake = this.handshake.bind(this);\n    this.request = this.request.bind(this);\n    this.createRequestMessage = this.createRequestMessage.bind(this);\n    this.decryptResponseMessage = this.decryptResponseMessage.bind(this);\n  }\n  async handshake(args) {\n    var _a, _b, _c, _d;\n    // Open the popup before constructing the request message.\n    // This is to ensure that the popup is not blocked by some browsers (i.e. Safari)\n    await ((_b = (_a = this.communicator).waitForPopupLoaded) === null || _b === void 0 ? void 0 : _b.call(_a));\n    const handshakeMessage = await this.createRequestMessage({\n      handshake: {\n        method: args.method,\n        params: Object.assign({}, this.metadata, (_c = args.params) !== null && _c !== void 0 ? _c : {})\n      }\n    });\n    const response = await this.communicator.postRequestAndWaitForResponse(handshakeMessage);\n    // store peer's public key\n    if ('failure' in response.content) throw response.content.failure;\n    const peerPublicKey = await importKeyFromHexString('public', response.sender);\n    await this.keyManager.setPeerPublicKey(peerPublicKey);\n    const decrypted = await this.decryptResponseMessage(response);\n    const result = decrypted.result;\n    if ('error' in result) throw result.error;\n    switch (args.method) {\n      case 'eth_requestAccounts':\n        {\n          const accounts = result.value;\n          this.accounts = accounts;\n          this.storage.storeObject(ACCOUNTS_KEY, accounts);\n          (_d = this.callback) === null || _d === void 0 ? void 0 : _d.call(this, 'accountsChanged', accounts);\n          break;\n        }\n    }\n  }\n  async request(request) {\n    var _a;\n    if (this.accounts.length === 0) {\n      switch (request.method) {\n        case 'wallet_sendCalls':\n          return this.sendRequestToPopup(request);\n        default:\n          throw standardErrors.provider.unauthorized();\n      }\n    }\n    switch (request.method) {\n      case 'eth_requestAccounts':\n        (_a = this.callback) === null || _a === void 0 ? void 0 : _a.call(this, 'connect', {\n          chainId: hexStringFromNumber(this.chain.id)\n        });\n        return this.accounts;\n      case 'eth_accounts':\n        return this.accounts;\n      case 'eth_coinbase':\n        return this.accounts[0];\n      case 'net_version':\n        return this.chain.id;\n      case 'eth_chainId':\n        return hexStringFromNumber(this.chain.id);\n      case 'wallet_getCapabilities':\n        return this.handleGetCapabilitiesRequest(request);\n      case 'wallet_switchEthereumChain':\n        return this.handleSwitchChainRequest(request);\n      case 'eth_ecRecover':\n      case 'personal_sign':\n      case 'wallet_sign':\n      case 'personal_ecRecover':\n      case 'eth_signTransaction':\n      case 'eth_sendTransaction':\n      case 'eth_signTypedData_v1':\n      case 'eth_signTypedData_v3':\n      case 'eth_signTypedData_v4':\n      case 'eth_signTypedData':\n      case 'wallet_addEthereumChain':\n      case 'wallet_watchAsset':\n      case 'wallet_sendCalls':\n      case 'wallet_showCallsStatus':\n      case 'wallet_grantPermissions':\n        return this.sendRequestToPopup(request);\n      default:\n        if (!this.chain.rpcUrl) throw standardErrors.rpc.internal('No RPC URL set for chain');\n        return fetchRPCRequest(request, this.chain.rpcUrl);\n    }\n  }\n  async sendRequestToPopup(request) {\n    var _a, _b;\n    // Open the popup before constructing the request message.\n    // This is to ensure that the popup is not blocked by some browsers (i.e. Safari)\n    await ((_b = (_a = this.communicator).waitForPopupLoaded) === null || _b === void 0 ? void 0 : _b.call(_a));\n    const response = await this.sendEncryptedRequest(request);\n    const decrypted = await this.decryptResponseMessage(response);\n    const result = decrypted.result;\n    if ('error' in result) throw result.error;\n    return result.value;\n  }\n  async cleanup() {\n    var _a, _b;\n    this.storage.clear();\n    await this.keyManager.clear();\n    this.accounts = [];\n    this.chain = {\n      id: (_b = (_a = this.metadata.appChainIds) === null || _a === void 0 ? void 0 : _a[0]) !== null && _b !== void 0 ? _b : 1\n    };\n  }\n  /**\n   * @returns `null` if the request was successful.\n   * https://eips.ethereum.org/EIPS/eip-3326#wallet_switchethereumchain\n   */\n  async handleSwitchChainRequest(request) {\n    var _a;\n    const params = request.params;\n    if (!params || !((_a = params[0]) === null || _a === void 0 ? void 0 : _a.chainId)) {\n      throw standardErrors.rpc.invalidParams();\n    }\n    const chainId = ensureIntNumber(params[0].chainId);\n    const localResult = this.updateChain(chainId);\n    if (localResult) return null;\n    const popupResult = await this.sendRequestToPopup(request);\n    if (popupResult === null) {\n      this.updateChain(chainId);\n    }\n    return popupResult;\n  }\n  async handleGetCapabilitiesRequest(request) {\n    assertGetCapabilitiesParams(request.params);\n    const requestedAccount = request.params[0];\n    const filterChainIds = request.params[1]; // Optional second parameter\n    if (!this.accounts.some(account => isAddressEqual(account, requestedAccount))) {\n      throw standardErrors.provider.unauthorized('no active account found');\n    }\n    const capabilities = this.storage.loadObject(WALLET_CAPABILITIES_STORAGE_KEY);\n    // Return empty object if capabilities is undefined\n    if (!capabilities) {\n      return {};\n    }\n    // If no filter is provided, return all capabilities\n    if (!filterChainIds || filterChainIds.length === 0) {\n      return capabilities;\n    }\n    // Convert filter chain IDs to numbers once for efficient lookup\n    const filterChainNumbers = new Set(filterChainIds.map(chainId => hexToNumber(chainId)));\n    // Filter capabilities\n    const filteredCapabilities = Object.fromEntries(Object.entries(capabilities).filter(_ref => {\n      let [capabilityKey] = _ref;\n      try {\n        const capabilityChainNumber = hexToNumber(capabilityKey);\n        return filterChainNumbers.has(capabilityChainNumber);\n      } catch (_a) {\n        // If capabilityKey is not a valid hex string, exclude it\n        return false;\n      }\n    }));\n    return filteredCapabilities;\n  }\n  async sendEncryptedRequest(request) {\n    const sharedSecret = await this.keyManager.getSharedSecret();\n    if (!sharedSecret) {\n      throw standardErrors.provider.unauthorized('No valid session found, try requestAccounts before other methods');\n    }\n    const encrypted = await encryptContent({\n      action: request,\n      chainId: this.chain.id\n    }, sharedSecret);\n    const message = await this.createRequestMessage({\n      encrypted\n    });\n    return this.communicator.postRequestAndWaitForResponse(message);\n  }\n  async createRequestMessage(content) {\n    const publicKey = await exportKeyToHexString('public', await this.keyManager.getOwnPublicKey());\n    return {\n      id: crypto.randomUUID(),\n      sender: publicKey,\n      content,\n      timestamp: new Date()\n    };\n  }\n  async decryptResponseMessage(message) {\n    var _a, _b;\n    const content = message.content;\n    // throw protocol level error\n    if ('failure' in content) {\n      throw content.failure;\n    }\n    const sharedSecret = await this.keyManager.getSharedSecret();\n    if (!sharedSecret) {\n      throw standardErrors.provider.unauthorized('Invalid session');\n    }\n    const response = await decryptContent(content.encrypted, sharedSecret);\n    const availableChains = (_a = response.data) === null || _a === void 0 ? void 0 : _a.chains;\n    if (availableChains) {\n      const chains = Object.entries(availableChains).map(_ref2 => {\n        let [id, rpcUrl] = _ref2;\n        return {\n          id: Number(id),\n          rpcUrl\n        };\n      });\n      this.storage.storeObject(AVAILABLE_CHAINS_STORAGE_KEY, chains);\n      this.updateChain(this.chain.id, chains);\n    }\n    const walletCapabilities = (_b = response.data) === null || _b === void 0 ? void 0 : _b.capabilities;\n    if (walletCapabilities) {\n      this.storage.storeObject(WALLET_CAPABILITIES_STORAGE_KEY, walletCapabilities);\n    }\n    return response;\n  }\n  updateChain(chainId, newAvailableChains) {\n    var _a;\n    const chains = newAvailableChains !== null && newAvailableChains !== void 0 ? newAvailableChains : this.storage.loadObject(AVAILABLE_CHAINS_STORAGE_KEY);\n    const chain = chains === null || chains === void 0 ? void 0 : chains.find(chain => chain.id === chainId);\n    if (!chain) return false;\n    if (chain !== this.chain) {\n      this.chain = chain;\n      this.storage.storeObject(ACTIVE_CHAIN_STORAGE_KEY, chain);\n      (_a = this.callback) === null || _a === void 0 ? void 0 : _a.call(this, 'chainChanged', hexStringFromNumber(chain.id));\n    }\n    return true;\n  }\n}","map":{"version":3,"names":["hexToNumber","isAddressEqual","SCWKeyManager","assertGetCapabilitiesParams","standardErrors","ScopedLocalStorage","ensureIntNumber","hexStringFromNumber","decryptContent","encryptContent","exportKeyToHexString","importKeyFromHexString","fetchRPCRequest","ACCOUNTS_KEY","ACTIVE_CHAIN_STORAGE_KEY","AVAILABLE_CHAINS_STORAGE_KEY","WALLET_CAPABILITIES_STORAGE_KEY","SCWSigner","constructor","params","metadata","communicator","callback","keyManager","storage","accounts","_a","loadObject","chain","id","_c","_b","appChainIds","handshake","bind","request","createRequestMessage","decryptResponseMessage","args","waitForPopupLoaded","call","handshakeMessage","method","Object","assign","response","postRequestAndWaitForResponse","content","failure","peerPublicKey","sender","setPeerPublicKey","decrypted","result","error","value","storeObject","_d","length","sendRequestToPopup","provider","unauthorized","chainId","handleGetCapabilitiesRequest","handleSwitchChainRequest","rpcUrl","rpc","internal","sendEncryptedRequest","cleanup","clear","invalidParams","localResult","updateChain","popupResult","requestedAccount","filterChainIds","some","account","capabilities","filterChainNumbers","Set","map","filteredCapabilities","fromEntries","entries","filter","_ref","capabilityKey","capabilityChainNumber","has","sharedSecret","getSharedSecret","encrypted","action","message","publicKey","getOwnPublicKey","crypto","randomUUID","timestamp","Date","availableChains","data","chains","_ref2","Number","walletCapabilities","newAvailableChains","find"],"sources":["../../../src/sign/scw/SCWSigner.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}